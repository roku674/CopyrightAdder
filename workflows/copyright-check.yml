name: Copyright Header Check

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  copyright-check:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    
    steps:
      - name: Checkout PR branch
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.head_ref }}
          token: ${{ secrets.GITHUB_TOKEN }}
          submodules: true
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Get changed files
        id: changed-files
        uses: tj-actions/changed-files@v40
        with:
          files: |
            **/*.java
            **/*.js
            **/*.ts
            **/*.jsx
            **/*.tsx
            **/*.cpp
            **/*.cc
            **/*.cxx
            **/*.c
            **/*.h
            **/*.hpp
            **/*.cs
            **/*.py
            **/*.go
            **/*.rs
            **/*.swift
            **/*.kt
            **/*.rb
            **/*.php
            **/*.pl
            **/*.sh
            **/*.bash
            **/*.zsh
            **/*.fish
            **/*.ps1
            **/*.psm1
            **/*.psd1
            **/*.yaml
            **/*.yml
            **/*.toml
            **/*.json
            **/*.xml
            **/*.html
            **/*.htm
            **/*.svg
            **/*.sql
            **/*.r
            **/*.R
            **/*.m
            **/*.scala
            **/*.clj
            **/*.cljs
            **/*.lisp
            **/*.el
            **/*.scm
            **/*.rkt
            **/*.lua
            **/*.dart
            **/*.jl
            **/*.ex
            **/*.exs
            **/*.erl
            **/*.hrl
            **/*.fs
            **/*.fsx
            **/*.fsi
            **/*.ml
            **/*.mli
            **/*.nim
            **/*.nims
            **/*.v
            **/*.zig
            **/*.d
      
      - name: Run Copyright Adder
        if: steps.changed-files.outputs.any_changed == 'true'
        env:
          CHANGED_FILES: ${{ steps.changed-files.outputs.all_changed_files }}
        run: |
          echo "Files to check for copyright headers:"
          echo "$CHANGED_FILES" | tr ' ' '\n'
          
          # Make script executable
          chmod +x CopyrightAdder/add_copyright_headers.sh
          
          # Process only the changed files
          for file in $CHANGED_FILES; do
            if [ -f "$file" ]; then
              echo "Processing: $file"
              ./CopyrightAdder/add_copyright_headers.sh "$file"
            fi
          done
      
      - name: Check for changes
        id: check-changes
        run: |
          if [[ -n $(git status --porcelain) ]]; then
            echo "changes=true" >> $GITHUB_OUTPUT
          else
            echo "changes=false" >> $GITHUB_OUTPUT
          fi
      
      - name: Commit changes
        if: steps.check-changes.outputs.changes == 'true'
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add -A
          git commit -m "Add copyright headers to new files"
          git push
      
      - name: Comment on PR
        if: steps.check-changes.outputs.changes == 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'âœ… Copyright headers have been automatically added to new/modified files in this PR.'
            })